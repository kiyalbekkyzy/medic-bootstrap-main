<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Панель администратора — AnalizGO</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{--bg:#f4f7fb;--card:#fff;--primary:#0b72d9;--muted:#63748b;}
  body{margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#10203a;}
  header.appbar{display:flex; align-items:center; justify-content:space-between; padding:16px 24px; background:#fff; box-shadow:0 2px 6px rgba(16,32,58,.06);}
  .app-title{display:flex; gap:12px; align-items:center;}
  .container{max-width:1100px; margin:20px auto; padding:0 16px;}
  .grid{display:flex; gap:20px; align-items:flex-start;}
  .sidebar{width:240px; background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(11,24,40,0.04);}
  .main{flex:1; background:var(--card); border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(11,24,40,0.04);}
  .nav-item{padding:10px 12px; border-radius:8px; cursor:pointer; color:var(--muted); display:flex; gap:10px; align-items:center;}
  .nav-item.active{background:#eef6ff; color:var(--primary); font-weight:600;}
  .section-title{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
  .form-row{display:flex; gap:10px; margin-bottom:10px;}
  input, select, textarea{padding:8px 10px; border:1px solid #e6eefc; border-radius:8px; font-size:14px; width:100%;}
  button.btn{padding:8px 12px; border-radius:8px; border:none; background:var(--primary); color:#fff; cursor:pointer; transition:0.2s;}
  button.btn:hover{background:#095bb5;}
  button.ghost{background:transparent; border:1px solid #e6eefc; color:var(--muted);}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th, td{padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left;}
  .small{font-size:13px; color:var(--muted);}
  .chip{display:inline-block; padding:6px 8px; border-radius:8px; background:#f1f5f9; font-size:13px;}
  .subtabs{display:flex; gap:8px; margin-bottom:10px;}
  .subtab{padding:6px 10px; border-radius:8px; border:1px solid #e6eefc; cursor:pointer;}
  .subtab.active{background:var(--primary); color:#fff;}
  @media(max-width:880px){ .grid{flex-direction:column} .sidebar{width:100%} }
  .small-btn{padding:4px 6px; font-size:12px; margin-right:4px;}
  .action-buttons button { margin-right:6px; }
  .edit-modal {
    display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:#fff; border-radius:12px; box-shadow:0 8px 30px rgba(16,32,58,0.2);
    padding:20px; z-index:1000; width:90%; max-width:500px; animation:fadeIn 0.3s ease;
  }
  .edit-modal.active { display:block; }
  .edit-modal h3 { margin-top:0; font-size:18px; margin-bottom:12px; }
  .edit-modal .form-row { margin-bottom:10px; }
  .edit-modal .buttons { display:flex; gap:12px; margin-top:12px; justify-content:flex-end; }
  @keyframes fadeIn { from{opacity:0; transform:translate(-50%,-48%);} to{opacity:1; transform:translate(-50%,-50%);} }
</style>
</head>
<body>
<header class="appbar">
  <div class="app-title">
    <strong>AnalizGO — Панель администратора</strong>
    <span id="hospital-info" class="small"></span>
  </div>
  <div>
    <button id="btn-logout" class="btn" title="Выйти"><i class="fa-solid fa-right-from-bracket"></i> Выйти</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <aside class="sidebar" aria-label="Навигация администратора">
      <div id="nav-accept" class="nav-item active"><i class="fa-solid fa-hand-holding-medical"></i> Прием анализа</div>
      <div id="nav-upload" class="nav-item"><i class="fa-solid fa-upload"></i> Загрузить результаты</div>
      <div id="nav-patients" class="nav-item"><i class="fa-solid fa-user-injured"></i> Пациенты</div>
      <div id="nav-doctors" class="nav-item"><i class="fa-solid fa-user-doctor"></i> Врачи</div>
      <div id="nav-results" class="nav-item"><i class="fa-solid fa-file-medical"></i> Результаты</div>
    </aside>

    <main class="main" role="main" aria-live="polite">
      <!-- Прием анализа -->
      <div id="view-accept" class="view">
        <div class="section-title">
          <h3>Прием анализа</h3>
          <span class="small">Добавляйте информацию о новых анализах пациента</span>
        </div>
        <div id="accept-form" style="margin-bottom:12px;">
          <div class="form-row">
            <select id="analysis-patient"><option value="">Выберите пациента</option></select>
            <input id="analysis-type" placeholder="Тип анализа"/>
          </div>
          <div class="form-row">
            <input type="date" id="analysis-date"/>
            <input type="file" id="analysis-file"/>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="save-analysis" class="btn">Сохранить</button>
            <button id="cancel-analysis" class="btn ghost">Отмена</button>
          </div>
        </div>
        <table id="accept-table">
          <thead><tr><th>Пациент</th><th>Тип анализа</th><th>Дата</th><th>Файл</th><th>Действия</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Загрузить результаты -->
      <div id="view-upload" class="view" style="display:none">
        <div class="section-title">
          <h3>Загрузить результаты</h3>
          <span class="small">Ищите прием анализа и прикрепляйте готовый файл</span>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <input type="text" id="search-patient-upload" placeholder="Имя пациента"/>
          <input type="date" id="search-date-upload"/>
          <button id="search-upload-btn" class="btn">Найти</button>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <select id="upload-analysis-select"><option value="">Выберите прием</option></select>
          <input type="file" id="upload-file"/>
          <button id="upload-btn" class="btn">Загрузить</button>
        </div>
        <div id="upload-msg" class="small"></div>
        <div style="margin-top:18px">
          <h4>Список загруженных результатов</h4>
          <table id="upload-table">
            <thead><tr><th>Пациент</th><th>Файл</th><th>Статус</th><th>Дата</th><th>Действия</th></tr></thead><tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Пациенты -->
      <div id="view-patients" class="view" style="display:none">
        <div class="section-title">
          <h3>Пациенты</h3>
          <div><button id="add-patient-btn" class="btn">Добавить пациента</button></div>
        </div>
        <div id="patient-form" style="display:none; margin-bottom:12px;">
          <div class="form-row">
            <input id="p-name" placeholder="ФИО"/>
            <select id="p-sex"><option value="">Пол</option><option value="М">М</option><option value="Ж">Ж</option></select>
          </div>
          <div class="form-row">
            <input id="p-nationality" placeholder="Национальность"/>
            <input id="p-dob" placeholder="Дата рождения (YYYY-MM-DD)"/>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="save-patient" class="btn">Сохранить</button>
            <button id="cancel-patient" class="btn ghost">Отмена</button>
          </div>
        </div>
        <table id="patients-table"><thead><tr><th>ФИО</th><th>Национальность</th><th>Пол</th><th>ДР</th><th>Действия</th></tr></thead><tbody></tbody></table>
      </div>

      <!-- Врачи -->
      <div id="view-doctors" class="view" style="display:none">
        <div class="section-title">
          <h3>Врачи</h3>
          <div><button id="add-doctor-btn" class="btn">Добавить врача</button></div>
        </div>
        <div id="doctor-form" style="display:none; margin-bottom:12px;">
          <div class="form-row">
            <input id="d-name" placeholder="ФИО"/>
            <input id="d-specialty" placeholder="Специальность"/>
            <select id="d-sex"><option value="">Пол</option><option value="М">М</option><option value="Ж">Ж</option></select>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="save-doctor" class="btn">Сохранить</button>
            <button id="cancel-doctor" class="btn ghost">Отмена</button>
          </div>
        </div>
        <table id="doctors-table"><thead><tr><th>ФИО</th><th>Спец.</th><th>Пол</th><th>Действия</th></tr></thead><tbody></tbody></table>
      </div>

      <!-- Результаты -->
      <div id="view-results" class="view" style="display:none">
        <div class="section-title">
          <h3>Результаты</h3>
          <div class="subtabs" role="tablist">
            <div id="sub-ready" class="subtab active">Готовые</div>
            <div id="sub-pending" class="subtab">В процессе</div>
          </div>
        </div>
        <table id="results-table"><thead><tr><th>Пациент</th><th>Файл</th><th>Врач</th><th>Статус</th><th>Дата</th><th>Действия</th></tr></thead><tbody></tbody>
      </div>
    </main>
  </div>
</div>

<!-- Модальное окно редактирования -->
<div id="edit-modal" class="edit-modal">
  <h3>Редактировать запись</h3>
  <div id="edit-fields"></div>
  <div class="buttons">
    <button id="save-edit" class="btn">Сохранить</button>
    <button id="cancel-edit" class="btn ghost">Отмена</button>
  </div>
</div>

<script>
(function(){
  // --- Настройка LocalStorage ---
  function get(key){ return JSON.parse(localStorage.getItem(key)||'[]'); }
  function set(key,val){ localStorage.setItem(key,JSON.stringify(val)); }
  if(!localStorage.getItem('analizgo_patients')) set('analizgo_patients',[]);
  if(!localStorage.getItem('analizgo_doctors')) set('analizgo_doctors',[]);
  if(!localStorage.getItem('analizgo_results')) set('analizgo_results',[]);
  if(!localStorage.getItem('analizgo_analysis_accept')) set('analizgo_analysis_accept',[]);

  // --- Навигация ---
  const views = {
    accept: document.getElementById('view-accept'),
    upload: document.getElementById('view-upload'),
    patients: document.getElementById('view-patients'),
    doctors: document.getElementById('view-doctors'),
    results: document.getElementById('view-results')
  };
  function showView(name){
    Object.values(views).forEach(v=>v.style.display='none');
    views[name].style.display='block';
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('nav-'+name).classList.add('active');
    if(name==='accept') renderAnalysisAccept();
    if(name==='upload') renderAnalysisUpload();
    if(name==='patients') renderPatients();
    if(name==='doctors') renderDoctors();
    if(name==='results') renderResults();
  }
  ['accept','upload','patients','doctors','results'].forEach(v=>{
    document.getElementById('nav-'+v).addEventListener('click',()=>showView(v));
  });
  document.getElementById('btn-logout').addEventListener('click',()=>{
    localStorage.removeItem('analizgo_current_admin');
    window.location.href='admin-login.html';
  });

  // --- Общие кнопки ---
  function createActionButtons(item, type){
    const wrapper = document.createElement('div');
    wrapper.className = 'action-buttons';
    const deleteBtn = document.createElement('button'); deleteBtn.className='btn small-btn'; deleteBtn.textContent='Удалить';
    deleteBtn.addEventListener('click',()=>{
      if(!confirm('Удалить этот элемент?')) return;
      const keys={patients:'analizgo_patients', doctors:'analizgo_doctors', accept:'analizgo_analysis_accept', results:'analizgo_results'};
      const data=get(keys[type]); set(keys[type], data.filter(d=>d.id!==item.id));
      if(type==='patients'){ renderPatients(); renderAnalysisAccept(); renderAnalysisUpload(); renderResults(); }
      if(type==='doctors'){ renderDoctors(); renderResults(); }
      if(type==='accept'){ renderAnalysisAccept(); renderAnalysisUpload(); }
      if(type==='results'){ renderAnalysisUpload(); renderResults(); }
    });
    const editBtn=document.createElement('button'); editBtn.className='btn small-btn'; editBtn.textContent='Редактировать';
    editBtn.addEventListener('click',()=>openEditModal(type,item));
    wrapper.appendChild(deleteBtn); wrapper.appendChild(editBtn);
    return wrapper;
  }

  // --- Модальное редактирование ---
  const editModal = document.getElementById('edit-modal'); const editFieldsDiv = document.getElementById('edit-fields'); let currentEdit=null;
  function openEditModal(type,item){
    currentEdit={type,item,original:{...item}}; editFieldsDiv.innerHTML='';
    const fields=[];
    if(type==='patients'){ fields.push({label:'ФИО',key:'name',type:'text'}); fields.push({label:'Национальность',key:'nationality',type:'text'}); fields.push({label:'Пол',key:'sex',type:'select',options:['М','Ж']}); fields.push({label:'Дата рождения',key:'dob',type:'date'});}
    if(type==='doctors'){ fields.push({label:'ФИО',key:'name',type:'text'}); fields.push({label:'Спец.',key:'specialty',type:'text'}); fields.push({label:'Пол',key:'sex',type:'select',options:['М','Ж']}); }
    if(type==='accept'){ fields.push({label:'Пациент',key:'patientId',type:'select',options:get('analizgo_patients').map(p=>({value:p.id,text:p.name}))}); fields.push({label:'Тип анализа',key:'type',type:'text'}); fields.push({label:'Дата',key:'date',type:'date'});}
    if(type==='results'){ fields.push({label:'Файл',key:'fileName',type:'text'}); fields.push({label:'Статус',key:'status',type:'select',options:['ready','pending']});}
    fields.forEach(f=>{
      const div=document.createElement('div'); div.className='form-row';
      const label=document.createElement('label'); label.textContent=f.label; label.style.width='100px';
      let input;
      if(f.type==='select'){ input=document.createElement('select'); f.options.forEach(o=>{ const opt=document.createElement('option'); opt.value=typeof o==='string'?o:o.value; opt.textContent=typeof o==='string'?o:o.text; input.appendChild(opt); }); }
      else{ input=document.createElement('input'); input.type=f.type; }
      input.value=item[f.key]||''; input.dataset.key=f.key; div.appendChild(label); div.appendChild(input); editFieldsDiv.appendChild(div);
    });
    editModal.classList.add('active');
  }
  document.getElementById('cancel-edit').addEventListener('click',()=>{ editModal.classList.remove('active'); });
  document.getElementById('save-edit').addEventListener('click',()=>{
    const inputs=editFieldsDiv.querySelectorAll('input,select'); inputs.forEach(i=>currentEdit.item[i.dataset.key]=i.value);
    const keys={patients:'analizgo_patients', doctors:'analizgo_doctors', accept:'analizgo_analysis_accept', results:'analizgo_results'};
    const data=get(keys[currentEdit.type]); set(keys[currentEdit.type], data.map(d=>d.id===currentEdit.item.id?currentEdit.item:d));
    editModal.classList.remove('active');
    if(currentEdit.type==='patients'){ renderPatients(); renderAnalysisAccept(); renderAnalysisUpload(); renderResults(); }
    if(currentEdit.type==='doctors'){ renderDoctors(); renderResults(); }
    if(currentEdit.type==='accept'){ renderAnalysisAccept(); renderAnalysisUpload(); }
    if(currentEdit.type==='results'){ renderAnalysisUpload(); renderResults(); }
  });

  // --- Рендер таблиц ---
  const patientsTable = document.querySelector('#patients-table tbody');
  function renderPatients(){
    const patients=get('analizgo_patients'); patientsTable.innerHTML='';
    patients.forEach(p=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.name}</td><td>${p.nationality}</td><td>${p.sex}</td><td>${p.dob}</td>`; tr.appendChild(createActionButtons(p,'patients')); patientsTable.appendChild(tr);
    });
    const select = document.getElementById('analysis-patient'); select.innerHTML='<option value="">Выберите пациента</option>';
    patients.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; select.appendChild(opt); });
  }

  const doctorsTable=document.querySelector('#doctors-table tbody');
  function renderDoctors(){
    const doctors=get('analizgo_doctors'); doctorsTable.innerHTML='';
    doctors.forEach(d=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.name}</td><td>${d.specialty}</td><td>${d.sex}</td>`; tr.appendChild(createActionButtons(d,'doctors')); doctorsTable.appendChild(tr);
    });
  }

  const acceptTable=document.querySelector('#accept-table tbody');
  function renderAnalysisAccept(){
    const accepts=get('analizgo_analysis_accept'); acceptTable.innerHTML='';
    accepts.slice().reverse().forEach(a=>{
      const patient=get('analizgo_patients').find(p=>p.id===a.patientId); const tr=document.createElement('tr');
      tr.innerHTML=`<td>${patient?patient.name:'—'}</td><td>${a.type}</td><td>${a.date}</td><td>${a.fileName||''}</td>`; tr.appendChild(createActionButtons(a,'accept')); acceptTable.appendChild(tr);
    });
    const select=document.getElementById('upload-analysis-select'); select.innerHTML='<option value="">Выберите прием</option>';
    accepts.forEach(a=>{ const p=get('analizgo_patients').find(p=>p.id===a.patientId); if(p){ const opt=document.createElement('option'); opt.value=a.id; opt.textContent=p.name+' — '+a.type; select.appendChild(opt); } });
  }

  const uploadTable=document.querySelector('#upload-table tbody');
  function renderAnalysisUpload(){
    const results=get('analizgo_results'); uploadTable.innerHTML='';
    results.slice().reverse().forEach(r=>{
      const patient=get('analizgo_patients').find(p=>p.id===r.patientId); const tr=document.createElement('tr');
      tr.innerHTML=`<td>${patient?patient.name:'—'}</td><td>${r.fileName}</td><td>${r.status}</td><td>${r.date}</td>`; tr.appendChild(createActionButtons(r,'results')); uploadTable.appendChild(tr);
    });
  }

  const resultsTableBody=document.querySelector('#results-table tbody');
  let resultsFilter='ready';
  function renderResults(){
    const results=get('analizgo_results'); resultsTableBody.innerHTML='';
    const filtered=results.filter(r=>(resultsFilter==='ready'? r.status==='ready' : r.status!=='ready'));
    filtered.slice().reverse().forEach(r=>{
      const patient=get('analizgo_patients').find(p=>p.id===r.patientId); const doctor=get('analizgo_doctors').find(d=>d.id===r.doctorId);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${patient?patient.name:'—'}</td><td>${r.fileName}</td><td>${doctor?doctor.name:''}</td><td>${r.status}</td><td>${r.date}</td>`; tr.appendChild(createActionButtons(r,'results')); resultsTableBody.appendChild(tr);
    });
  }
  document.getElementById('sub-ready').addEventListener('click',()=>{ resultsFilter='ready'; document.querySelectorAll('.subtab').forEach(s=>s.classList.remove('active')); document.getElementById('sub-ready').classList.add('active'); renderResults(); });
  document.getElementById('sub-pending').addEventListener('click',()=>{ resultsFilter='pending'; document.querySelectorAll('.subtab').forEach(s=>s.classList.remove('active')); document.getElementById('sub-pending').classList.add('active'); renderResults(); });

  // --- Добавление пациентов ---
  document.getElementById('add-patient-btn').addEventListener('click',()=>document.getElementById('patient-form').style.display='block');
  document.getElementById('cancel-patient').addEventListener('click',()=>document.getElementById('patient-form').style.display='none');
  document.getElementById('save-patient').addEventListener('click',()=>{
    const name=document.getElementById('p-name').value, sex=document.getElementById('p-sex').value, nationality=document.getElementById('p-nationality').value, dob=document.getElementById('p-dob').value;
    if(!name){ alert('Введите имя'); return; }
    const patients=get('analizgo_patients'); patients.push({id:Date.now(),name,sex,nationality,dob}); set('analizgo_patients',patients); renderPatients(); document.getElementById('patient-form').style.display='none';
  });

  // --- Добавление врачей ---
  document.getElementById('add-doctor-btn').addEventListener('click',()=>document.getElementById('doctor-form').style.display='block');
  document.getElementById('cancel-doctor').addEventListener('click',()=>document.getElementById('doctor-form').style.display='none');
  document.getElementById('save-doctor').addEventListener('click',()=>{
    const name=document.getElementById('d-name').value, sex=document.getElementById('d-sex').value, specialty=document.getElementById('d-specialty').value;
    if(!name){ alert('Введите имя'); return; }
    const doctors=get('analizgo_doctors'); doctors.push({id:Date.now(),name,sex,specialty}); set('analizgo_doctors',doctors); renderDoctors(); document.getElementById('doctor-form').style.display='none';
  });

  // --- Прием анализов ---
  document.getElementById('save-analysis').addEventListener('click',()=>{
    const patientId=document.getElementById('analysis-patient').value,type=document.getElementById('analysis-type').value,date=document.getElementById('analysis-date').value,fileInput=document.getElementById('analysis-file'); 
    if(!patientId||!type||!date){ alert('Заполните все поля'); return; }
    const fileName=fileInput.files[0]?fileInput.files[0].name:''; const arr=get('analizgo_analysis_accept'); arr.push({id:Date.now(),patientId,type,date,fileName}); set('analizgo_analysis_accept',arr); renderAnalysisAccept();
  });

  // --- Загрузка результатов ---
  document.getElementById('upload-btn').addEventListener('click',()=>{
    const acceptId=document.getElementById('upload-analysis-select').value; const file=document.getElementById('upload-file').files[0];
    if(!acceptId||!file){ alert('Выберите прием и файл'); return; }
    const accept=get('analizgo_analysis_accept').find(a=>a.id==acceptId); const results=get('analizgo_results');
    results.push({id:Date.now(),patientId:accept.patientId,fileName:file.name,status:'ready',date:accept.date,doctorId:''}); set('analizgo_results',results); renderAnalysisUpload(); renderResults();
    document.getElementById('upload-msg').textContent='Файл загружен успешно';
  });

  // --- Инициализация ---
  renderPatients(); renderDoctors(); renderAnalysisAccept(); renderAnalysisUpload(); renderResults();
})();
</script>


<!-- Подключаем фронтенд скрипт -->
<script src="appointment_admin.js"></script>
</body>
</html>


